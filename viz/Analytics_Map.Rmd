---
title: "Analytics_Map"
output: html_document
author: 'Christian Kirifidis (Detecon International GmbH)' 
---

# SBB CHALLENGE - Cup the plastic

**Team:** `4 Layers`
**Team members:** Alexandra Haas, Michael Schroeder, Sergej Bannik, Christian Kirifidis
**Afiliated company:** Detecon Schweiz AG & Detecon International GmbH

## LOAD LIBRARIES - VARIABLES - FUNCTIONS

The necessary libraries are loaded (might have to be installed prior). Relevant data is loaded and map functions are initiated. 

**Sources:**
- Shapefiles: https://opendata.swiss/de/dataset/amtliches-ortschaftenverzeichnis-mit-postleitzahl-und-perimeter

- MapModel background: https://carto.com/

```{r setupMapP}
#-------------- LOAD LIBRARIES --------------#
library(leaflet)   # For map building
library(sf)   # For importing & handling geo-data
library(rgdal)   # For importing & handling geo-data
library(maps)   # For importing map models
library(tidyr)   # For data manipulation & handling
library(dplyr)   # For data manipulation & handling
library(viridis)   # For color pallets

rm(list = ls())   # Remove all objects in storage before starting

#-------------- LOAD SHAPE --------------#
# SOURCE FOR PLZ SHAPEFILES ADMINN.CHB
shapeData <- sf::read_sf(dsn = "./Shapefile_PLZ", layer = "PLZO_PLZ", as_tibble = F)


#-------------- LOAD Data --------------#
# Load data about cup consumptionn per day
cups_per_day <-  readr::read_delim("~/Desktop/StartHack/04 Git/START19-DCN/data_analysis/cups_per_day.tsv", "\t", escape_double = FALSE, col_types = cols(`PLZ To` = col_number()), trim_ws = TRUE)
# Adapt column names and data types
names(cups_per_day)[1] <- "PLZ"
names(cups_per_day)[2] <- "PLZ_Name"
cups_per_day$PLZ <- as.integer(cups_per_day$PLZ)


#-------------- TRANSFORM --------------#
# LOAD POLYGONS FOR PLZ IN SWITZERLAND
shapeData <- shapeData %>% select('PLZ', 'geometry')
shapeData <- st_transform(shapeData, "+proj=longlat +ellps=WGS84 +datum=WGS84")


extractCoord <- function(PLZ) {
  # This funciton extracs the geometry information and
  # saves it in a data frame object for a given plz
  index <- which(shapeData$PLZ == PLZ)
  x <- shapeData[index, "geometry"][[1]][[1]]
  x <- data.frame(x[[1]])
  colnames(x) <- c('lng', 'lat')
  x <- data.frame(x)
  x$PLZ <- PLZ
  return(x)
}   # Function to get polygons


extractCoordList <- function(plzList){
  # This function extracts the geometry information for a 
  # list of plzs
  
  # INITZATE TEMP DATA FRAME TO SAVE GEO DATA
  temp_plz_df <- data.frame()
  
  for(plz in plzList){
    # Goes through the list of plzs and creates a
    # df with geoinformation
    if(is.na(plz)|!plz %in% shapeData$PLZ){
      next
    }
    # Extract coord long/lat for current plz
    temp_plz_coord <- extractCoord(plz)
    
    if(nrow(temp_plz_df != 0)){
      # Only proceed if the loop is in the second iteration
      # E.G. temp_plz_df != 0,0
      temp_plz_df[nrow(temp_plz_df)+1,] <- NA
    } # End add empty row
    
    # Combine with previous coordinates
    temp_plz_df <- rbind(temp_plz_df, NULL, temp_plz_coord)
  }
  
  # RETRUN LIST OF PLZ & LONG/LAT
  return(temp_plz_df)
  
} # END OF FUNCTION extractCoordList
```




## INITIATE DATA ENRICHED MAP 

In this step the traffic data of commutes is merged with the polygon information of the plzs. Then the map is initiated and stored for further ploting. 

```{r loadMap}
# LOAD DF FOR RELEVANT PLZ
plzList <- unique(cups_per_day$PLZ)
plzList <- na.omit(plzList)
plz_to_Map <- extractCoordList(plzList)


# MAP VALUES TO PLZ
plz_to_Map <- left_join(x = plz_to_Map, y = cups_per_day, by = 'PLZ')


bins <- c(0, 50, 200, 1000, 10000, 100000)
pal <- colorBin("Reds", domain = plz_to_Map$traffic, bins = bins)


# INITIATE MAP
m <- leaflet(plz_to_Map) %>%
  # Coordinates Bern 46.94809 7.44744
  addTiles() %>%  setView(lng = 7.44744, lat = 46.94809, zoom = 10) %>%
  # CartoDB.Positron for grey
  # CartoDB.DarkMatter for black
  addProviderTiles('CartoDB.Positron') %>% 
  addPolygons(lng = plz_to_Map$lng , lat = plz_to_Map$lat, opacity = 0, fillOpacity = 0.8, smoothFactor = 0, color = ~pal(na.omit(unique(bins)))) %>% addLegend("bottomright", pal = pal, values = bins, title = "Number of Cups", opacity = 1)
```


## MAP PLOT

The map object was stored in the `m` object. This can be plotted or further enriched using `leaflet pipeline operations`. 

```{r plotMap}
# Plot the map object
m
```



`#--------------------------------------- END OF SCRIPT ---------------------------------------#` 


